# OpenOCD config script for rtl8710ec
#
# Author : Snow Yang
# Date   : 2018-12-20
#

adapter_khz 3000

set _CHIPNAME rtl8710ec

swd newdap $_CHIPNAME cpu -irlen 4 -expected-id 0
set _TARGETNAME $_CHIPNAME.cpu
target create $_TARGETNAME cortex_m -chain-position $_TARGETNAME

reset_config none separate 

cortex_m reset_config sysresetreq

$_TARGETNAME configure -event gdb-attach {
}

#shutdown OpenOCD daemon when gdb detaches
$_TARGETNAME configure -event gdb-detach {
  shutdown
}

set PERI_ON_BASE 0x4100C000

proc regread32 {address} {
    mem2array memar 32 $address 1
    return $memar(0)
}

proc mflash_pre_init { } {
  halt

  reset halt
  
# Set flashloader mode
  set reg_val [regread32 $($::PERI_ON_BASE + 0x026C)]
  mww $($::PERI_ON_BASE + 0x026C) $(($reg_val & ~(0xFFFF << 16)) | (0x01 << 28))
# Stop CPU to secure state
  set reg_val [regread32 0xE000EE08]
  mww $($::PERI_ON_BASE + 0x021C) $(($reg_val & ~(0x01 << 17)) & ~(1 << 16))
}

set MFLASH_CONFIG_START 0x3000a040
set MFLASH_RUN_WITH_HALT 0
