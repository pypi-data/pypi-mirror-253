"use strict";(self.webpackChunkskillsnetwork_authoring_extension=self.webpackChunkskillsnetwork_authoring_extension||[]).push([[568],{7953:(e,t,o)=>{o.a(e,(async(e,n)=>{try{o.d(t,{Z:()=>k});var a=o(645),i=o(7583),l=o(5923),r=o(14),s=o(8623),c=o(3311),d=o(6973),u=o(3619),h=o(3191),w=o.n(h),b=o(1854),p=o(5449),g=e([u,c,s,p]);[u,c,s,p]=g.then?(await g)():g;const y={activate:v,id:"skillsnetwork-authoring-extension:plugin",autoStart:!0,requires:[r.IMainMenu,b.INotebookTracker,a.IDocumentManager]};class f{createNew(e,t){if(u.OH.SHOW_PUBLISH_BUTTON_FOR!==t.path)return new l.DisposableDelegate((()=>{}));{const o=async()=>{const o=t.path.split("/").pop()||"",n=u.OH.TOKENS.get(o);if(void 0===n)return console.log("No atlas or awb token found for id",e.id),void await(0,i.showDialog)({title:"Publishing Restricted",body:`Only the lab '${u.OH.TOKENS.keys().next().value}' can be published during this editing session.`,buttons:[i.Dialog.okButton({label:"Dismiss"})]});"version_id"in w()(n)?(0,c.Wk)((0,c.So)(n),e,t,n):(0,c.nK)((0,c.SJ)(n),e,t)},n=async()=>{const o=await(0,s.nu)(e,t),n=new Blob([o],{type:"application/x-ipynb+json"}),a=URL.createObjectURL(n),i=document.createElement("a");i.setAttribute("download",t.path),i.setAttribute("href",a),document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(a)},a=new i.ToolbarButton({className:"download-lab-button",label:"Download Notebook",onClick:n,tooltip:"Download the current notebook ipynb file to your local system"}),r=new i.ToolbarButton({className:"publish-lab-button",label:"Publish on SN",onClick:o,tooltip:"Publish Lab"}),d=new i.ToolbarButton({className:"sn-file-library-button",label:"SN File Library",onClick:()=>new p.E(e.id).launch(),tooltip:"Skills Network File Library"});return e.toolbar.insertItem(8,"download",a),e.toolbar.insertItem(9,"sn-file-library",d),e.toolbar.insertItem(10,"publish",r),new l.DisposableDelegate((()=>{a.dispose(),r.dispose(),d.dispose()}))}}}async function m(e,t){t.forEach((e=>{e.dispose()}))}async function v(e,t,o,n){if(console.log("Activating skillsnetwork-authoring-extension button plugin!"),"learn"==await(0,u.IK)())return;const a=await(0,u.Nz)(),l=await(0,u.fe)(),r=await(0,u.D2)();console.log("Using default kernel: ",u.OH.PY_KERNEL_NAME),e.docRegistry.addWidgetExtension("Notebook",new f),await e.serviceManager.ready,e.restored.then((async()=>{if(await m(0,o),"NO_TOKEN"!==a&&"local"!==r)try{await(0,s._Y)(a,n,e.serviceManager.contents)}catch(e){i.Dialog.flush(),(0,d.YZ)(),console.log(e)}else if("NO_TOKEN"!==l&&"local"!==r)try{await(0,s.Ps)(l,n,e.serviceManager.contents)}catch(e){i.Dialog.flush(),(0,d.YZ)(),console.log(e)}})),console.log("Activated skillsnetwork-authoring-extension button plugin!")}const k=y;n()}catch(_){n(_)}}))},3619:(e,t,o)=>{o.a(e,(async(e,n)=>{try{o.d(t,{CC:()=>r,D2:()=>u,DO:()=>l,IK:()=>s,Nz:()=>c,OH:()=>w,XM:()=>i,fe:()=>d});var a=o(4582);const e=e=>{let t=e.baseUrl;return t.endsWith("/")||(t+="/"),t},i=await(async()=>{const t=window.location.href,o=new URL(t).searchParams.get("atlas_base_url");if(null===o){const t={method:"GET"},o=a.ServerConnection.makeSettings(),n=e(o)+"skillsnetwork-authoring-extension/config",i=await a.ServerConnection.makeRequest(n,t,o);return(await i.json()).ATLAS_BASE_URL}return decodeURIComponent(o)})(),l=await(async()=>{const t=window.location.href,o=new URL(t).searchParams.get("awb_base_url");if(null===o){const t={method:"GET"},o=a.ServerConnection.makeSettings(),n=e(o)+"skillsnetwork-authoring-extension/config",i=await a.ServerConnection.makeRequest(n,t,o);return(await i.json()).AWB_BASE_URL}return decodeURIComponent(o)})(),r=await(async()=>{const t=window.location.href,o=new URL(t).searchParams.get("sn_file_library_url");if(null===o){const t={method:"GET"},o=a.ServerConnection.makeSettings(),n=e(o)+"skillsnetwork-authoring-extension/config",i=await a.ServerConnection.makeRequest(n,t,o);return(await i.json()).SN_FILE_LIBRARY_URL}return decodeURIComponent(o)})(),s=async()=>{const e=window.location.href;let t=new URL(e).searchParams.get("mode");return"learn"==t?t:"author"},c=async()=>{const e=window.location.href,t=new URL(e).searchParams.get("atlas_token");return null!==t?t:"NO_TOKEN"},d=async()=>{const e=window.location.href,t=new URL(e).searchParams.get("awb_token");return null!==t?t:"NO_TOKEN"},u=async()=>{const e=window.location.href;let t=new URL(e).searchParams.get("env_type");return"jupyterlab"!==t&&"jupyterlite"!==t&&(t="local"),console.log("Env type: ",t),"jupyterlab"===t||"local"===t?(w.PY_KERNEL_NAME=await h(),w.DEFAULT_LAB_NAME="lab.ipynb"):"jupyterlite"===t&&(w.PY_KERNEL_NAME="python",w.DEFAULT_LAB_NAME="lab.jupyterlite.ipynb"),t},h=async()=>{let e=await(await a.KernelSpecAPI.getSpecs()).kernelspecs,t=Object.keys(e).filter((function(e){return e.includes("python")})).sort();return t[t.length-1]};class w{}w.TOKENS=new Map,w.SHOW_PUBLISH_BUTTON_FOR=void 0,w.PREV_PUB_HASH="prev_pub_hash",w.BACKUP_EXT=".backup",n()}catch(e){n(e)}}),1)},6973:(e,t,o)=>{o.d(t,{Up:()=>l,YZ:()=>u,fP:()=>d,ql:()=>s,wW:()=>c,wj:()=>r});var n=o(8832),a=o(7583);class i extends n.Widget{constructor(){const e=document.createElement("div"),t=new a.Spinner;e.appendChild(t.node),e.style.padding="15px",super({node:e})}}const l=e=>{const t=new i;(0,a.showDialog)({title:e,body:t,buttons:[a.Dialog.cancelButton()]})},r=e=>{const t=new i;return(0,a.showDialog)({title:e,body:t,buttons:[]})},s=e=>(0,a.showDialog)({title:e,body:"Are you sure you want to publish? This action is not reversible",buttons:[a.Dialog.okButton(),a.Dialog.cancelButton()]}).then((e=>{if(!e.button.accept)throw new Error("Operation cancelled by the user.")})),c=()=>{(0,a.showDialog)({title:"Success!",body:"This lab has been successfully published!",buttons:[a.Dialog.okButton()]}).then((e=>{})).catch((e=>{}))},d=()=>{(0,a.showDialog)({title:"Failed to Publish",body:"This lab failed to publish.",buttons:[a.Dialog.okButton()]}).then((e=>{})).catch((e=>{}))},u=()=>{(0,a.showDialog)({title:"Failed to Load Lab",body:"This lab failed to load.",buttons:[a.Dialog.okButton()]}).then((e=>{})).catch((e=>{}))}},3311:(e,t,o)=>{o.a(e,(async(e,n)=>{try{o.d(t,{B4:()=>m,RZ:()=>y,SJ:()=>p,So:()=>g,Wk:()=>f,nK:()=>v});var a=o(2600),i=o.n(a),l=o(6973),r=o(7583),s=o(3619),c=o(8623),d=o(9581),u=o.n(d),h=o(3191),w=o.n(h),b=e([s,c]);[s,c]=b.then?(await b)():b;const p=e=>u().create({baseURL:s.XM,headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json","Access-Control-Allow-Origin":"*",Accept:"application/json"}}),g=e=>u().create({baseURL:s.DO,headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json","Access-Control-Allow-Origin":"*",Accept:"application/json"}}),y=async(e,t)=>{try{const o=w()(t),n=o.version_id,a=o.lab_id,i=`${o.lab_name}.ipynb`,l=await e.get(`api/v1/labs/${a}/lab_versions/${n}/download`).then((e=>e.data));return r.Dialog.flush(),{labFilename:i,body:l}}catch(e){throw console.log(e),"Failed to fetch notebook"}},f=async(e,t,o,n)=>{if(!await(0,l.ql)("Publishing your lab onto Skills Network...").then((e=>!0)).catch((e=>!1)))return;(0,l.wj)("Publishing your changes...");const a=w()(n),s=a.version_id,d=a.lab_id,u=window.location.href;let h=new URL(u).searchParams.get("env_type")||"local";console.log("Env type in handler 1: ",h),"jupyterlite"!==h&&await(0,c._7)(t,o);const b=await(0,c.nu)(t,o),p=new(i());return p.append("publish","true"),p.append("draft[changelog]","updated notebook"),p.append("file",b),new Promise((async(t,o)=>{await e.post(`api/v1/labs/${d}/lab_versions/${s}/drafts`,p).then((e=>{console.log("SUCCESSFULLY PUSHED",e),r.Dialog.flush(),(0,l.wW)()})).catch((e=>{console.log(e),r.Dialog.flush(),(0,l.fP)()}))}))},m=e=>e.get("v1/labs").then((e=>(r.Dialog.flush(),e.data))).catch((e=>{throw console.log(e),"Failed to fetch notebook"})),v=async(e,t,o)=>{if(!await(0,l.ql)("Publishing your lab onto Skills Network...").then((e=>!0)).catch((e=>!1)))return;(0,l.wj)("Publishing your changes...");const n=window.location.href;let a=new URL(n).searchParams.get("env_type")||"local";console.log("Env type in handler 2: ",a),"jupyterlite"!==a&&await(0,c._7)(t,o);const i=await(0,c.nu)(t,o);return new Promise((async(t,o)=>{await e.post("v1/labs",{body:i}).then((e=>{console.log("SUCCESSFULLY PUSHED",e),r.Dialog.flush(),(0,l.wW)()})).catch((e=>{console.log(e),r.Dialog.flush(),(0,l.fP)()}))}))};n()}catch(e){n(e)}}))},1568:(e,t,o)=>{o.a(e,(async(e,n)=>{try{o.r(t),o.d(t,{default:()=>r});var a=o(4822),i=o(7953),l=e([i,a]);[i,a]=l.then?(await l)():l;const r=[i.Z,a.G];n()}catch(e){n(e)}}))},4822:(e,t,o)=>{o.a(e,(async(e,n)=>{try{o.d(t,{G:()=>p});var a=o(14),i=o(8832),l=o(7583),r=o(1854),s=o(645),c=o(6973),d=o(3619),u=o(8623),h=o(3191),w=o.n(h),b=e([d,u]);[d,u]=b.then?(await b)():b;const p={id:"skillsnetwork-authoring-extension:menu",autoStart:!0,requires:[a.IMainMenu,r.INotebookTracker,s.IDocumentManager],activate:async(e,t,o,n)=>{if(console.log("Activating skillsnetwork-authoring-extension menu plugin!"),"learn"==await(0,d.IK)())return;const a="edit-lab-from-token";e.commands.addCommand(a,{label:"Edit a Lab",execute:()=>g(0,n,e.serviceManager.contents)});const{commands:l}=e,r=new i.Menu({commands:l});r.title.label="Skills Network",t.addMenu(r,{rank:80}),r.addItem({command:a,args:{}}),console.log("Activated skillsnetwork-authoring-extension menu plugin!")}};function g(e,t,o){let n=document.createElement("div"),a=document.createElement("label");a.textContent="Enter your authorization token";let r=document.createElement("input");r.className="jp-mod-styled",n.appendChild(a),n.appendChild(r),(0,l.showDialog)({title:"Edit a Lab",body:new i.Widget({node:n}),buttons:[l.Dialog.cancelButton(),l.Dialog.okButton()]}).then((async e=>{if(e.button.accept){(0,c.Up)("Loading up your lab...");const e=r.value;"version_id"in w()(e)?await(0,u.Ps)(e,t,o):await(0,u._Y)(e,t,o)}})).catch((e=>{l.Dialog.flush(),(0,c.YZ)(),console.log(e)}))}n()}catch(y){n(y)}}))},5449:(e,t,o)=>{o.a(e,(async(e,n)=>{try{o.d(t,{E:()=>w});var a=o(8832),i=o(7583),l=o(3619),r=o(3191),s=o.n(r),c=e([l]);l=(c.then?(await c)():c)[0];var d,u=function(e,t){if(!t.has(e))throw new TypeError("attempted to get private field on non-instance");return t.get(e)};class h extends a.Widget{constructor(e){const t=document.createElement("iframe"),o=l.OH.TOKENS.get(e);"project_id"in(o?s()(o):{})&&(t.src=`${l.CC}?atlas_token=${o}`),t.setAttribute("frameborder","0"),t.setAttribute("allow","clipboard-read; clipboard-write"),t.classList.add("sn-file-library-frame"),super({node:t})}}class w{constructor(e){d.set(this,void 0),function(e,t,o){if(!t.has(e))throw new TypeError("attempted to set private field on non-instance");t.set(e,o)}(this,d,e)}launch(){const e=new i.Dialog({title:"Skills Network File Library",body:new h(u(this,d)),hasClose:!0,buttons:[]}),t=e.node.querySelector(".jp-Dialog-content");t&&t.classList.add("sn-file-library-dialog"),e.launch()}}d=new WeakMap,n()}catch(e){n(e)}}))},8623:(e,t,o)=>{o.a(e,(async(e,n)=>{try{o.d(t,{Ps:()=>p,_7:()=>u,_Y:()=>g,nu:()=>d});var a=o(7583),i=o(3619),l=o(3311),r=e([i,l]);[i,l]=r.then?(await r)():r;const s=e=>{var t,o,n,a,i,l;return console.log("Cell:",e),console.log("Model:",null==e?void 0:e.model),console.log("Model Value:",null===(t=null==e?void 0:e.model)||void 0===t?void 0:t.value),console.log("Model Value Text:",null===(n=null===(o=null==e?void 0:e.model)||void 0===o?void 0:o.value)||void 0===n?void 0:n.text),{cell_type:e.model.type,id:e.model.id,metadata:{},outputs:[],source:[null!==(l=null===(i=null===(a=null==e?void 0:e.model)||void 0===a?void 0:a.value)||void 0===i?void 0:i.text)&&void 0!==l?l:""]}},c=e=>({cell_type:e.model.type,id:"",metadata:{},outputs:[],source:[e.model.value.text||""]}),d=(e,t)=>{const o=[];e.content.widgets.forEach((e=>{const t=s(e);o.push(t)}));const n=t.model.metadata.toJSON(),a=t.model.nbformat,i=t.model.nbformatMinor,l={cells:o,metadata:n,nbformat:a,nbformat_minor:i};return JSON.stringify(l,null,2)};async function u(e,t){const o=await b(e,t),n=await N(o);await t.ready,t.model.metadata.set(i.OH.PREV_PUB_HASH,n),t.save().then((()=>{console.log("Notebook saved with updated metadata.")})).catch((e=>{console.error("Failed to save notebook:",e)}))}function h(e){var t,o,n,a,l,r,s;return"string"==typeof e&&(e=JSON.parse(e)),"object"!=typeof e||null===e||!("metadata"in e)&&!("content"in e)?(console.error("Lab content is of unknown type: ",typeof e,"\n Value: \n",e),""):null!==(s=null!==(n=null===(o=null===(t=e.metadata)||void 0===t?void 0:t[i.OH.PREV_PUB_HASH])||void 0===o?void 0:o.toString())&&void 0!==n?n:null===(r=null===(l=null===(a=e.content)||void 0===a?void 0:a.metadata)||void 0===l?void 0:l[i.OH.PREV_PUB_HASH])||void 0===r?void 0:r.toString())&&void 0!==s?s:""}function w(e){var t;if("string"==typeof e)try{e=JSON.parse(e)}catch(e){return console.error("Error parsing lab content string: ",e),!1}if("object"!=typeof e||null===e||!("cells"in e)&&(!e.content||!("cells"in e.content)))return console.error("Lab content is of unknown type or missing 'cells': ",typeof e,"\n Value: \n",e),!1;const o=e.cells||(null===(t=e.content)||void 0===t?void 0:t.cells);return 0===o.length||1===o.length&&0===o[0].source.length}const b=(e,t)=>{const o=[];return e.content.widgets.forEach((e=>{const t=c(e);o.push(t)})),JSON.stringify(o,null,2)},p=async(e,t,o)=>{let n,{labFilename:a,body:r}=await(0,l.RZ)((0,l.So)(e),e);if(await f(a,o,t),await y(a,r,o,t),i.OH.SHOW_PUBLISH_BUTTON_FOR=a,i.OH.TOKENS.set(a,e),await k(`./${a}`,o))n=t.openOrReveal(a);else{if(n=t.createNew(a,"notebook",{name:i.OH.PY_KERNEL_NAME}),void 0===n)throw Error("Error loading lab");await m(n,r)}return n},g=async(e,t,o)=>{let{instructions_file_path:n,body:a}=await(0,l.B4)((0,l.SJ)(e));const r=v(n);let s;if(await f(r,o,t),await y(r,a,o,t),i.OH.SHOW_PUBLISH_BUTTON_FOR=r,i.OH.TOKENS.set(r,e),await k(`./${r}`,o))s=t.openOrReveal(r);else{if(s=t.createNew(r,"notebook",{name:i.OH.PY_KERNEL_NAME}),void 0===s)throw Error("Error loading lab");await m(s,JSON.parse(a))}return s};async function y(e,t,o,n){const l=`./${e}`,r=await k(l,o);if(r&&h(t)!==h(r))try{await S(r,o,n),await(0,a.showDialog)({title:"Your Lab was Updated",body:`The newest published version of "${e}" is loaded. Your previous version has been backed up under "${e}${i.OH.BACKUP_EXT}.ipynb"`,buttons:[a.Dialog.okButton({label:"Dismiss"})]})}catch(t){await(0,a.showDialog)({title:"Error with Previous File",body:`While trying to load your lab: "${e}", we found that you have another file named "${e}" that already exists in this folder, please delete it or rename it so we can load your published version"`,buttons:[a.Dialog.okButton({label:"Dismiss"})]})}}async function f(e,t,o){const n=`./${e}`,a=await k(n,t);a&&(await E(n,o),w(a)&&await t.delete(n))}const m=async(e,t,o)=>{if(await e.context.ready,"local"!==o)if(e.context&&e.context.model){e.context.model.fromJSON(t);try{await e.context.save()}catch(e){console.error("Error saving notebook:",e)}}else console.error("Notebook model is not initialized.")},v=e=>(null!=e?e:i.OH.DEFAULT_LAB_NAME).replace(/^.*[\\\/]/,"");async function k(e,t){try{return await t.get(e)}catch(e){if(e instanceof Error){const t=e;if(t.response&&404!==t.response.status)throw console.error("Error checking for existent backup file: ",e),e;return null}throw console.error("Unexpected error occured: ",e),e}}async function _(e,t){const o=t.findWidget(e);if(o){try{o.context.model.dirty&&await o.context.save()}catch(e){console.error("Error saving widget content:",e)}o.close()}}async function E(e,t){const o=t.findWidget(e);if(o)try{const e=t.contextForWidget(o);e&&e.model&&(e.model.dirty=!1),o.close()}catch(e){console.error("Error closing widget:",e)}}async function S(e,t,o){const n=e.path,a=n.split(".").pop(),l=`${n.replace(/\.[^/.]+$/,"")}${i.OH.BACKUP_EXT}.${a}`;if(await k(l,t))try{await t.delete(l)}catch(e){console.error("Unexpected error occured: ",e)}try{await _(n,o),await t.rename(n,l)}catch(e){console.error("Unexpected error occured: ",e)}}async function N(e){const t=(new TextEncoder).encode(e),o=await crypto.subtle.digest("SHA-256",t);return Array.from(new Uint8Array(o)).map((e=>e.toString(16).padStart(2,"0"))).join("")}n()}catch(O){n(O)}}))}}]);